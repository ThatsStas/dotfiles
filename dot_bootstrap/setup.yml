# Detect if we're running on a device running on a graphical desktop. If so, run in addition to the common.yml also the graphical.yml playbook.
---
- name: Machine setup
  hosts: localhost
  become: true
  connection: local
  gather_facts: true

  tasks:
    - name: Detect display server (X11 or Wayland)
      ansible.builtin.shell: |
        if [ -n "$(pgrep -a Xorg)" ]; then
          echo X11
        elif loginctl show-session $(loginctl | awk 'NR==2{print $1}') -p Type | grep -q wayland; then
          echo Wayland
        else
          echo none
        fi
      args:
        executable: /bin/bash
      register: display_type
      changed_when: false

    - name: Show detected display type
      debug:
        msg: "Detected display: {{ display_type.stdout }}"

    - name: Run amazon linux configuration
      include_tasks: amazon-linux.yml
      when: ansible_distribution == "Amazon"

    - name: Skip remeaining setup for Amazon Linux setup
      meta: end_play
      when: ansible_distribution == "Amazon"

    - name: Run common configuration
      include_tasks: common.yml

    - name: Run graphics configuration
      include_tasks: graphical.yml
      when: display_type.stdout != "none"


